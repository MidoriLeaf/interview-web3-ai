# 钱包产品

[TOC]

## 1.钱包的分类，根据私钥的管理方式进行分类

- 交易所钱包：
  - 私钥管理管理：KMS，TEE，CloadHSM, Wallet.data 数据库文件；安全等级 CloadHSM > TEE > KMS > 数据库文件
- 去中心化钱包（HD 钱包）
  - 私钥管理方式：本地设备里面
- 硬件钱包（HD 钱包）
  - 私钥管理方式：硬件设备，离线
- 智能合约钱包
  - EOA 地址，社交恢复钱包
- 多签钱包
  - 多把密钥控制一个钱包
- MPC 托管钱包
  - 密钥多方计算产生，GG18 经过 5 轮算法，GG20 是 5 轮算法阐述；密钥分片的形式，节点之间相互不知道具体的密钥分片



## 2.描述交易所钱包的功能模块

- 地址分配：钱包事先生成一批地址，用户在业务注册平台，钱包分配地址给用户。
- 充值：用户转钱到用户在交易所的地址，钱包扫块，风控也同时扫块；交易扫到之后通知业务层，业务层去风控校验充值信息，等到过了确认位之后再次通知业务层，业务层给用户入账
- 提现：用户在交易所发起提现，业务层将交易发送到钱包和风控，钱包拿到交易之后，请求签名机钱包，在请求签名签名是要进行风控校验，校验通过之后签名交易，把交易签名返回来，钱包端构建完整的交易发送到区块链网络，交易上链之后，扫链程序扫到这笔交易之后通知业务层，业务层进行风控校验之后通知钱包提现成功
- 归集：用户充值金额大于一定金额，进行归集，转到归集地址，归集地址发起交易发送到区块链网络，扫链扫到交易就算成功，逻辑类似提现；
- 热转冷：热钱包金额大于一定金额，进行热转冷，流程和提现类似；
- 冷转热：热钱包金额少于一定金额，需要冷钱包多签管理人员从冷钱划钱到热钱包，这里也行扫链维护交易，方便对账。
- 回滚：因为链本身发生区块链重组或者区块链回滚，需要把区块回滚的交易进行处理
- 对账：财务部，交易所上层业务部门，钱包部门，三个部门之前资产负债表，资产负债快照，每日交易日报，结算日报，周，月，半年度，年度。
- 风险控制：
  - 底层数据处理流程
    - 交易抓取数据
    - 地址标签库
    - 数据清洗
  - 业务数据
    - 交易链路风控
    - 地址黑，灰，白检查
    - 对账风控



## 2.扫到交易的时候怎么去判定交易是充值，提现

1. 检查交易中的 from 和 to 地址：

   - 若 `to == 用户钱包地址`，通常是**充值**；

   - 若 `from == 用户钱包地址`，通常是**提现**。

2. 解析交易类型：

   - 原生币交易（如 ETH、BNB）直接看交易字段即可；

   - ERC20 等 Token 交易需解析合约日志中的 `Transfer` 事件，判断转账的实际 `from` 和 `to`。

3. 识别用户地址归属：
   - 判断交易地址是否属于当前钱包管理的地址列表，识别用户是发起方还是接收方。

4. 结合操作行为上下文：

   - 若交易由用户在钱包中主动发起（如点击“发送”），可判定为提现；

   - 若资产被动到账，用户未主动发起操作，通常为充值。

5. 识别对方地址类型：

   - 若对方地址是已知交易所、跨链桥或合约地址，结合方向判断更准确；

   - 可借助地址标签服务（如链上标签库）提升识别能力。

6. 多地址钱包场景下的内部转账排除：
   - 如果 from 和 to 都是同一用户的地址，应标记为“内部转账”，非充值或提现。

7. 建立识别优先级与容错机制：

   - 使用交易方向 + 行为上下文 + 地址识别综合判断；

   - 模糊交易可设置为“待识别”状态，允许用户手动标注或反馈，优化后续识别准确性。



## 3.HD 钱包的功能

- 地址生成
- 收款
- 转账
- 闪兑
- 发现（Dapp浏览器）
- 行情
- 资讯
- 质押
- NFT
- 跨链
- 法币出入金
- 集成信用卡
- 我的资产



## 4.地址生成的全流程

- 地址生成：助记词-->MasterKey->n childKey->publicKey->address-> 信息和私钥和助记词编码加密入库
- 导入助记词：导助记词-->MasterKey->n childKey->publicKey->address-> 信息和私钥和助记词编码加密入库
- 导出助记词：助记词 code-解密解码>展示给用户
- 导出私钥：获取私钥->解密>展示给用户
- 导入私钥: 私钥->公钥->地址->信息和私钥加密入库



## 5.收款业务流程

- 获取地址-->展示地址和二维码



## 6.转账业务流程

- 用户输入转账信息（含收款地址和金额）-->选择 gas 的方式-->本地交易离线签名与构建 --> 广播交易



## 7.闪兑怎么做

- 1inch
- API VIP 账号开通流程



## 8.Dapp 接入流程

- 钱包和 Dapp 通信模式
  - JS 桥接(Windows)
  - Hook
  - Websocker
- 接入流程
  - Dapp url, 从后台请求
  - Js 桥接
  - 授权，Dapp 操作钱包资金



## 9.行情接入流程

```
okex------------|
binance---------|
bybit-----------|-----------|
xxxdex----------|           |
                            |----- Price Aggragator----Api-->HD 钱包
uniswap---------|           |
pancakeswap-----|-----------|
xxxdex----------|
```



## 10.质押接入流程

- 链的质押特点
- ETH 质押： 请看 The Web3 课程文档
- SOL 质押：
  - 第一步：创建质押账户
  - 第二步：将质押的资金转入质押账户
  - 第三步：将质押的权限委托给验证者（P2P）
  - 第四步：解除质押：
    - 将质押账户编程 inactive
    - 等质押周期结束
    - 从质押账户里面取回质押，废弃账户
- ADA 质押：
  - 第一步：把要质押的资金转到地址里面
  - 第二步：将质押的权限委托给验证者（P2P）
  - 第三步：操作取回质押等质押周期结束之后取回资金
- XTZ 质押：
  - 第一步：创建质押账户转入资金质押
  - 第二步：取回质押，等到质押周期结束，提回资金
- 质押接入

## 11.ERC721 和 ERC115 的区别（NFT）

- ERC721：不可分割
- ERC115：NFT 可以以交易包的形式交易，可以分割



## 12.解释OP 跨链桥底层逻辑

在 Optimism 的跨链桥中，资产跨链的核心逻辑依赖于 Optimism Rollup 的消息传递机制和双桥合约结构。这个桥的主要作用是让用户能够在 L1（以太坊主网）和 L2（Optimism）之间安全地转移资产。

1. **整体架构是一个双向桥，分别部署在 L1 和 L2 上，各自有一个 StandardBridge 合约，同时借助 CrossDomainMessenger 进行消息传递。**
2. **当用户从 L1 向 L2 充值时**（比如将 ETH 充值到 Optimism）：
   - 用户会调用 L1 上的桥合约，合约会把资产锁定在主网合约里；
   - 然后触发一条跨链消息，由 CrossDomainMessenger 发送给 L2；
   - L2 的桥合约接收到消息后，给用户地址铸造等值资产，实现充值；
   - 这个过程几乎是同步的，几分钟内可以完成。
3. **而从 L2 向 L1 提现的逻辑更加严格**，因为涉及到 Optimism 的安全模型：
   - 用户先在 L2 调用桥合约销毁资产，同时发送一条消息到 L1；
   - 这条消息不会立刻生效，而是进入一个 **7 天的挑战期**（Challenge Period）；
   - 这是 Rollup 的欺诈证明机制，如果没人对这条消息提出异议，7 天后用户可以在 L1 调用 `finalizeWithdrawal()` 取回资产；
   - 这个机制虽然慢，但可以确保 L2 的状态是可验证和可信的。
4. **跨链的资产管理方式一般采用锁定+铸造 / 销毁+释放模式**，比如 ETH 会被桥合约锁定，L2 上则是铸造的 WETH。对代币来说，桥合约之间需要建立映射关系，部分特殊资产可能使用自定义桥或官方支持列表。
5. **作为产品经理，需要重点关注这些要素**：
   - 用户体验上充值快、提现慢的节奏如何引导；
   - 代币支持范围及映射关系维护；
   - 跨链失败或挑战期间的状态如何展示给用户；
   - 安全边界和提示机制（比如用户误用非官方桥的风险）。

**一句话总结**：
 Optimism 的跨链桥本质上是通过 Rollup 的消息通道 + 双合约机制实现的“L1 锁定 / L2 铸造”和“L2 销毁 / L1 释放”的双向资产转移逻辑，提现流程引入 7 天挑战期以保障链下状态安全性。



## 13.解释Polygon 跨链底层逻辑

 Polygon 跨链桥底层逻辑是基于 Polygon PoS 的双合约结构 + Checkpoint 验证机制来实现 L1（以太坊主网）和 Polygon PoS 链之间的资产转移。整个过程分为两个方向：**L1 → L2 的充值** 和 **L2 → L1 的提现**，核心逻辑如下：

1. **跨链桥核心组件：**

   - **RootChainManager（部署在 L1）**：负责监听和管理跨链消息；

   - **ChildChainManager（部署在 L2）**：接收消息并执行相关操作；

   - **Predicate 合约**：用于锁定、验证和释放资产；

   - **State Sync 机制**：Polygon 的官方 L2 和 L1 状态通信协议。

2. **L1 → L2 充值流程（Deposit）：**用户把资产从以太坊桥接到 Polygon

   - 用户调用 L1 的 `RootChainManager`，同时将资产发送到对应的 `Predicate` 合约；

   - RootChainManager 会记录这笔跨链事件，并通过 State Sync 机制，把跨链指令同步到 Polygon 的 `ChildChainManager`；

   - L2 收到指令后，在用户地址上**铸造等量的资产**（通常是 WETH、WERC20 等）；

   - 用户在 Polygon 上收到资产，充值完成。

3. **L2 → L1 提现流程（Withdraw）：**用户从 Polygon 把资产提回以太坊：

   - 用户在 L2 的桥合约调用 `withdraw()`，销毁在 Polygon 上的资产；

   - 此操作会被打包进 Polygon 的 PoS 区块，并作为 Checkpoint 提交给以太坊（Checkpoint 每 30 分钟提交一次）；

   - 等待 Polygon 验证者将该区块提交并在以太坊上确认（大约需要 30~60 分钟）；

   - 用户在以太坊上调用 `exit()`，并提供该交易的 Merkle 证明；

   - 合约验证无误后，从 L1 的 Predicate 合约释放用户资产。

4. 对产品侧的思考：

- 相比于 OP、Arbitrum 等 Rollup 桥，Polygon 提现更快（约 1 小时 vs. 7 天），更适合日常使用；
- 但对用户来说，Polygon 的桥流程中存在“Checkpoint + Exit”这类链下复杂逻辑，用户体验设计要尽可能隐藏这些技术细节；
- 产品应提供清晰的进度状态（如“等待验证者提交 Checkpoint”、“等待用户执行 Exit”）；
- 同时支持用户查看跨链状态、Retry 出错交易、自动 Exit 辅助等操作。

**一句话总结**：

Polygon 的跨链桥通过 RootChainManager + ChildChainManager + Predicate 合约 + Checkpoint 提交机制，实现了 L1 锁定 / L2 铸造、L2 销毁 / L1 释放的资产跨链逻辑，提现流程依赖 Polygon 的共识提交而非挑战期，因此速度相对较快但结构复杂。



## 14.解释DappLink 跨链桥底层逻辑

 DappLink 是一个支持多链生态的跨链桥协议，其底层逻辑主要是通过**链间消息传输协议 + 多签验证机制**来完成跨链资产或数据的转移。不同于像 Optimism 或 Polygon 那种特定 L2 的系统桥，DappLink 更像是一个**中立的第三方跨链基础设施**，实现了多链资产跨链和消息调用的能力。

1. **核心设计思路：**

   **DappLink 的核心理念**：**源链锁定 / 目标链释放 + 验证节点网络完成中继与确认**。底层主要包含：

   - **跨链合约**：部署在每条支持的链上，负责资产锁定、释放或合约调用；

   - **验证者网络（Validator/MPC 节点）**：监听源链事件，经过共识签名后在目标链上提交证明；

   - **中继层（Relayer）**：负责转发链间事件和消息，触发目标链交易执行；

   - **链上与链下协同**：DappLink 的跨链不是纯粹链上完成，而是依赖可信的多签验证机制。

2. **跨链资产转移流程（以 ETH → BNB 为例）：**

   - 用户在源链（例如 Ethereum）调用 DappLink 的跨链合约，将 ETH 锁定；

   - 合约事件被验证者网络监听；

   - 验证者对该事件生成多签证明（如基于 Threshold Signature Scheme），并提交到目标链（BNB）；

   - 目标链上的 DappLink 合约收到足够的签名，执行释放或铸造操作，将等值资产转给用户；

   - 用户完成跨链。

3. **跨链消息调用（例如跨链合约调用）：**

   DappLink 不仅支持资产跨链，也支持 **跨链消息传递**，即用户可以从一条链触发另一条链上的合约逻辑，这可以支持比如“在主网上发起调用，在 Layer2 上执行操作”的复杂交互。

   - 用户在源链调用 DappLink 合约并附带消息数据；

   - 验证者监听该交易并构造跨链指令；

   - 在目标链由 DappLink 合约调用目标合约，传入消息内容。

4. **安全性与设计优势**：

   - **多签验证机制**：核心安全依赖于一组去中心化验证者，只有多数签名才能推动目标链动作；

   - **支持多链拓展**：每条链只需部署标准合约，支持横向扩展；

   - **适配性强**：可集成 EVM 链，也可以适配非 EVM 系链（如 Aptos、Sui）。

5. **产品侧的思考**：

   - DappLink 跨链时间相比官方桥更快，通常在 1~3 分钟完成，但依赖于验证者签名速度；

   - 用户体验设计中，应处理好链上确认延迟、签名失败、跨链状态反馈等；

   - 作为产品经理，需要关注如何在 UI 上简化复杂过程，比如进度展示、Retry、手续费预估等环节；

   - 同时也要考虑资产映射清单维护、支持链的扩展机制和资产安全预警。

**一句话总结：**

DappLink 的跨链桥逻辑是基于“多链部署合约 + 验证者多签共识 + 中继消息转发”的架构模型，实现了高扩展性和相对快速的资产与消息跨链，是去中心化跨链协议中更灵活的一种实现方式。

