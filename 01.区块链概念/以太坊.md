# 以太坊

[TOC]

## 1. 智能合约大小大约可以多大？

在以太坊虚拟机（EVM）中，智能合约的大小限制为24,576字节（24KB），由以太坊协议规定。EIP-170规定了此限制，以保证网络性能与安全。

这个限制在以太坊改进提案 EIP-170 中进行了规范，这是由于某些极端情况下的安全和资源考虑。实际部署过程中，合约大小应在编写和部署时加以关注，以避免超出这个限制。

**EIP-3860改进提案**

EIP-3860 是一个提议引入字节码长度的 Gas 上限的以太坊改进提案。其主要目标是为创建过长字节码的操作增加额外的 Gas 成本，从而限制超长合约的负面影响。下面是该提案的关键点：

**背景与动机**

在以太坊智能合约中，`initcode` 是部署合约时发送到 EVM 的字节码。超长的 `initcode` 会给网络带来负担，尤其是在处理 Gas 费用方面。通过对 `initcode` 长度引入额外的 Gas 成本，EIP-3860 旨在减少恶意或非故意的超长字节码对网络的潜在影响。

**提案内容**

具体来说，EIP-3860提案要求在部署时根据字节码长度增加 Gas 成本，避免网络因处理过长的字节码而遭受负担。这种机制类似于其他 Gas 成本优化提案，旨在激励开发者编写更简洁的合约代码。

**影响与意义**

EIP-3860 通过引入字节码长度相关的 Gas 成本，鼓励开发者优化合约的字节码，从而减少部署超大合约的频率。这不仅可以缓解网络压力，还可以提高合约执行的效率和安全性。

虽然该提案不会直接改变合约的大小限制（24 KB），但会影响开发者在编写和部署合约时的成本考量。



## 2. 简要说明 ERC721 和 ERC 1155 的区别

ERC721和ERC1155都是以太坊上的智能合约标准，用于定义不同类型的数字资产和代币。ERC721标准最初用于定义不可替代代币（Non-Fungible Token，NFT），而ERC1155标准则用于定义可替代和不可替代代币。

ERC721代币是唯一的、不可替代的，每个代币都有其自己的标识符和属性，这使得它们适用于代表数字艺术品、游戏道具等非可替代物品。例如，如果您在以太坊上购买了一张NFT数字艺术品，那么只有您才能拥有这个唯一的代币。

ERC1155代币则是可替代和不可替代的，一个ERC1155代币可以代表一组相同的数字资产，这些资产可以被分割和组合。这使得它们适用于游戏中的道具、虚拟货币等可替代物品。

ERC1155标准与ERC721标准最大的区别是，一个ERC1155合约可以定义多个代币，而ERC721合约只能定义一个。此外，ERC1155代币可以被批量转移，而ERC721代币只能单独转移。

另外，ERC-1159是一种新的标准提案，旨在解决以太坊上代币发行和交易的问题。该标准结合了ERC20和ERC721的优点，可以在同一合约中定义可替代和不可替代的代币，同时还支持代币发行和销毁的燃烧机制。此外，ERC-1159还可以提高代币发行的效率，减少网络拥堵，降低代币交易的成本。



## 3. 简要说明 ERC 1559 作用

ERC-1559是以太坊的一项改进提案，旨在改善以太坊的交易费用机制。当前的以太坊交易费用是由矿工根据交易的竞争情况自由决定的，这可能导致高昂的费用和交易延迟。

ERC-1559提出了一种基于区块空间占用和市场需求的新交易费用机制，其中包括以下要点：

- 每个区块包含的交易数量将被限制在一个预定义的容量范围内，这将导致交易费用的波动性减少。
- 交易费用将由一个算法自动计算，以确保快速确认的交易能够获得更高的优先级。
- 一部分交易费用将被销毁，而不是支付给矿工，这将有助于减少以太坊的通货膨胀。
- 这些改进有望提高以太坊的交易效率，降低交易费用，并减少以太坊的通货膨胀。



## 4. 在 EIP-1559 之前，如何计算以太坊交易的成本？

在EIP-1559之前，以太坊交易的成本由矿工通过拍卖机制来决定，矿工会选择最高出价的交易，并将其包含在下一个区块中。

交易的成本由Gas Price和Gas Limit决定：

- Gas Price是以太坊网络中的一种计量单位，用于衡量交易的复杂性。
- Gas Limit是指交易可以使用的最大Gas数量。交易的成本等于Gas Price乘以Gas Limit。

因此，交易的成本取决于Gas Price和Gas Limit的值，这些值由交易的发送者设置。



## 5. ETH转账的底层原理

ETH 转账的底层原理可以简化理解为“链上数据的状态更新”。当发起一笔转账时，本质上是构造一笔交易，将其签名并广播到以太坊网络，最终由节点验证并写入区块链，从而完成账户余额的更改。以下是这个过程的详细步骤：

1. 连接以太坊网络，加载发送方的钱包和私钥（通常通过 go-ethereum 等客户端库实现）。
2. 获取当前账户的 nonce（交易计数器），确保交易顺序唯一。
3. 将待转账的 ETH 数量换算为以太坊内部使用的最小单位 wei。
4. 设置交易参数：接收地址、转账金额、gas 限额、以及 gas 单价。
5. 构造一笔未签名的交易，包括上述参数。
6. 使用发送方的私钥对交易进行签名，确保只有账户所有者能发起交易。
7. 将签名后的交易通过节点广播至整个以太坊网络。
8. 网络中的验证节点会验证交易签名、nonce 和余额等信息，确认合法后将其打包进新区块。
9. 区块被链上共识机制确认，交易完成，链上状态随之更新：发送方余额减少，接收方余额增加。



## 6. **以太坊预编译合约的地址是什么？**

**答：**
 以太坊的预编译合约位于固定的合约地址范围内，起始地址是 `0x0000000000000000000000000000000000000001`，到 `0x0000000000000000000000000000000000000009`（在 Ethereum 主网截至上海升级前）。这些地址分别代表一些性能关键、计算密集型的加密函数。

以下是以太坊前 9 个常用预编译合约地址（主网）及其功能：

| 地址        | 功能说明                                         |
| ----------- | ------------------------------------------------ |
| 0x01        | `ecrecover` - 用于签名恢复公钥                   |
| 0x02        | `sha256` - 计算 SHA-256 哈希                     |
| 0x03        | `ripemd160` - 计算 RIPEMD-160 哈希               |
| 0x04        | `identity` - 身份函数，返回原数据                |
| 0x05 ~ 0x08 | BLS12-381 曲线上的椭圆曲线操作（用于 zk-SNARKs） |
| 0x09        | `blake2f` - 用于 Blake2 压缩函数                 |



从 Istanbul 升级起，还加入了更多高级加密预编译合约，地址范围继续扩展（如 EIP-196、EIP-197 和 EIP-198 等）。

预编译合约是由客户端实现的“原生函数”，虽然表现为合约地址，但它们不是用 Solidity 编写，也不在 EVM 中执行，而是由客户端直接运行，因此速度快、gas 成本低，非常适合加密和验证操作。



## 7. 解释一下 EIP-4337

EIP-4337 通过引入抽象账户（AA），使以太坊账户系统更灵活、安全，支持更复杂的账户管理和支付机制。通过这种方式，用户能够在不直接签名交易的情况下，利用 AA 账户进行操作，并且将 gas 费用的支付方式进行了灵活化处理。

1. **EOA 与 AA 区别：**
   - **EOA（Externally Owned Account）**：即外部账户，是我们通常使用的以太坊账户类型，使用私钥签名交易并发起操作。所有交易的 **gas 费用**都由 EOA 账户支付。
   - **AA（Abstract Account）**：抽象账户，是一种具有合约功能的账户。与 EOA 不同，AA 账户不仅可以持有资产，还可以执行合约代码，允许更多灵活的交易和账户管理。
2. **主要功能与优势：**
   - **Gas 费用支付灵活性**：在传统的 EOA 模式下，交易的 gas 费由用户的 EOA 账户支付。而通过 EIP-4337，**AA 账户可以支付交易的 gas 费用**，这意味着用户不再需要直接使用其 EOA 账户进行签名和支付 gas，提供了更高的灵活性和便利性。
   - **安全性提高**：AA 账户支持更多灵活的安全设置，例如多重签名、非对称签名等，可以显著增强账户的安全性。这样，用户可以设定规则，避免私钥泄漏的风险。
3. **交易与签名机制**：
   - 通过 EIP-4337，AA 可以通过一个称为 **“user operation”** 的新交易类型，来发起交易。这些操作可以通过专门的合约来管理、验证和执行，而不再需要传统的 EOA 签名方式。


