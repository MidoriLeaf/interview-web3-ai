# 合约部署

[TOC]

## 1. 在实际生产中，如果想要保证测试网和主网的合约地址一致，应当怎么做？

**方案一：**合约地址是由 nonce 和 address 决定的，所以只要保证 nonce 和 address 一样即可。

```solidity
new_address = hash(sender, nonce)
```

**方案二：**使用 create2, 该操作码背后的整体思想是使结果地址独立于未来事件。无论区块链上发生什么，总是可以将合约部署在预先计算的地址上。

新地址是以下函数的函数：

0xFF，一个防止与碰撞的常数CREATE

发件人自己的地址

盐（发送者提供的任意值）

待部署合约的字节码

```solidity
new_address = hash(0xFF, sender, salt, bytecode)
```

CREATE2保证如果使用和提供的sender进行部署，它将存储在.bytecodeCREATE2saltnew_address

因为bytecode包含在此计算中，所以其他代理可以依赖这样一个事实：如果合约曾经部署到 new_address，那么它将是他们所知道的。这是反事实部署背后的关键概念。



## 2. 你是用过哪些种类的合约升级方式，你是怎么操作他们的，升级过程中需要注意哪些事项？

- 创建新合约并迁移数据：这种方法需要编写新的合约代码，并将旧合约中的数据迁移到新合约中。这种方式需要确保数据的正确迁移，并且需要将旧合约地址作为参数传递给新合约，以便其他合约和用户可以找到新合约。
- 使用库合约：这种方式可以通过将合约的逻辑与数据分离来进行升级。新的逻辑可以放在一个新的库合约中，并且可以将新的库合约地址设置为旧合约的一个新变量。这样，新逻辑就可以被调用，而数据不需要迁移。
- 使用代理合约：这种方式也称为升级合约模式。旧合约被称为代理合约，它只包含一些基本的逻辑，如转发交易和调用新合约。新合约则包含更复杂的逻辑。在这种方式中，所有交易都被发送到代理合约，代理合约再将交易转发到新合约进行处理。

在进行合约升级之前，需要确保在升级过程中没有数据丢失或不一致，并且需要考虑安全性问题。操作时需要注意确保权限控制，保护用户资产等安全措施，避免出现意外或者恶意的操作。建议在开发和测试环境中进行合约升级的实验，并使用多重签名等方式确保升级操作的安全性。

升级过程中需要注意 public 变量的存放 slot 位置，否则会导致数据错乱。







